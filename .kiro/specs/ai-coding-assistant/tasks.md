# Implementation Plan

## 任务概述

本实现计划将 AI 编程助手插件的开发分解为一系列增量任务。每个任务都建立在前一个任务的基础上，确保代码始终处于可工作状态。任务按照"核心功能优先"的原则组织，先实现基本的 ReAct 循环，再逐步添加高级功能。

## 已完成的工作

✅ **核心 ReAct 循环架构** - Task 类已实现完整的推理-行动循环，支持循环计数和最大次数限制
✅ **工具系统基础** - Tool 接口、BaseTool 抽象类、ToolExecutor 已实现，支持工具注册、验证和执行
✅ **基础通信** - AgentWebviewProvider 已实现与 Webview 的消息通信
✅ **API 集成** - ApiHandler 已实现流式 LLM 调用

## 任务列表

### 第一阶段：动态提示词系统和核心工具

- [x] 1. 实现动态系统提示词生成系统






  - 创建 PromptBuilder 类负责动态构建系统提示词
  - 实现基础提示词模板（角色定义、Markdown 规则、工具使用指南、能力说明、规则、目标等）
  - 实现工具定义的动态注入（从 ToolExecutor 获取并格式化为 XML 文档）
  - 实现上下文信息的动态注入（工作目录、系统信息等）
  - 在 Task 类中使用 PromptBuilder 替代静态文件读取
  - _Requirements: 6.1, 7.1, 13.1, 13.2_

- [x] 2. 实现工作模式管理系统





  - 创建 ModeManager 类管理不同工作模式
  - 定义 WorkMode 类型和 ModeDefinition 接口
  - 实现四种预置模式配置：
    - 🏗️ Architect 模式（架构设计和规划）
    - 💻 Code 模式（代码编写和重构）
    - ❓ Ask 模式（解释和文档）
    - 🪲 Debug 模式（调试和问题诊断）
  - 为每种模式创建特定的提示词片段和文件编辑限制
  - 实现模式切换逻辑和当前模式获取
  - 集成 ModeManager 到 PromptBuilder 以动态调整提示词
  - 在 AgentWebviewProvider 中集成 ModeManager
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6_

- [x] 3. 实现 AttemptCompletionTool






  - 创建 AttemptCompletionTool 用于标记任务完成
  - 实现结果参数验证和格式化
  - 更新 Task 类以识别 attempt_completion 工具调用并结束循环
  - 向 Webview 发送任务完成消息
  - _Requirements: 6.6, 13.1_

- [x] 4. 实现基础文件操作工具






  - 实现 ReadFileTool（读取文件内容，带行号格式）
  - 实现 WriteFileTool（写入文件内容，支持创建目录）
  - 实现 ListFilesTool（列出目录内容，支持递归）
  - 添加文件路径验证和安全检查（防止路径遍历攻击）
  - 在 AgentWebviewProvider 中注册这些工具
  - _Requirements: 13.1, 13.2, 13.4_

- [ ]* 4.1 为文件操作工具编写单元测试
  - 测试 ReadFileTool 的各种场景（文件存在、不存在、权限问题）
  - 测试 WriteFileTool 的各种场景（创建新文件、覆盖文件、创建目录）
  - 测试 ListFilesTool 的各种场景（递归、非递归、空目录）
  - 测试文件路径验证逻辑（路径遍历攻击防护）
  - _Requirements: 13.1, 13.2, 13.4_

- [x] 5. 实现权限管理系统






  - 创建 PermissionManager 类
  - 实现 PermissionSettings 数据模型（读取、写入、执行权限）
  - 实现权限检查逻辑（checkPermission 方法）
  - 实现用户确认对话框（使用 vscode.window.showWarningMessage）
  - 在 ToolExecutor 中集成权限检查
  - 为需要权限的工具（WriteFileTool、ExecuteCommandTool）添加 requiresPermission 标记
  - 在 AgentWebviewProvider 中初始化 PermissionManager
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 6. 检查点 - 测试基础功能




  - 确保动态提示词系统正常工作
  - 确保工作模式切换正常
  - 确保文件操作工具可以正常执行
  - 确保权限系统正常拦截危险操作
  - 测试完整的 ReAct 循环（读取文件 → 分析 → 完成）

### 第二阶段：高级工具和上下文系统

- [x] 7. 实现高级文件编辑工具





  - 实现 ApplyDiffTool（精确的代码编辑，基于 diff 格式）
  - 实现 InsertContentTool（在指定行插入内容）
  - 实现 SearchFilesTool（正则表达式搜索，带上下文行）
  - 添加工具错误处理和友好的错误消息
  - _Requirements: 13.3, 13.5_

- [ ]* 7.1 为高级编辑工具编写单元测试
  - 测试 ApplyDiffTool 的代码编辑逻辑
  - 测试 InsertContentTool 的行插入逻辑
  - 测试 SearchFilesTool 的正则表达式匹配
  - _Requirements: 13.3, 13.5_

- [x] 8. 实现命令执行和诊断工具






  - 实现 ExecuteCommandTool（终端命令执行，支持工作目录）
  - 实现 GetDiagnosticsTool（获取 VSCode 诊断信息）
  - 实现 ListCodeDefinitionNamesTool（获取代码定义概览）
  - 添加命令执行的安全检查和权限验证
  - _Requirements: 13.5, 13.6_

- [ ]* 8.1 为命令和诊断工具编写单元测试
  - 测试 ExecuteCommandTool 的命令执行
  - 测试 GetDiagnosticsTool 的诊断信息获取
  - 测试 ListCodeDefinitionNamesTool 的代码分析
  - _Requirements: 13.5, 13.6_

- [x] 9. 实现上下文收集系统





  - 创建 ContextCollector 类
  - 实现当前文件和选中代码的收集
  - 实现光标位置和诊断信息的收集
  - 实现项目文件树的收集（递归列出所有文件）
  - 实现上下文大小限制和智能截断
  - 集成上下文收集到 Task 启动流程
  - 在用户消息中自动附加上下文信息
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_

- [ ]* 9.1 为上下文收集系统编写单元测试
  - 测试各种上下文信息的收集
  - 测试上下文大小限制
  - 测试智能选择逻辑
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 10. 检查点 - 测试高级功能
  - 确保所有工具正常工作
  - 确保上下文收集正确
  - 测试复杂的多步骤任务（搜索 → 编辑 → 执行命令）

### 第三阶段：UI 增强和用户体验

- [x] 11. 增强 Webview UI - 消息显示系统






  - 重构 App.tsx 以支持消息列表状态管理
  - 创建 MessageList 组件（显示所有消息）
  - 创建 Message 组件（支持文本、代码块、工具调用）
  - 集成 react-markdown 实现 Markdown 渲染
  - 集成 react-syntax-highlighter 实现语法高亮
  - 实现自动滚动到最新消息
  - 处理来自 Extension 的消息（stream_chunk、tool_call、tool_result、error、task_complete）
  - _Requirements: 4.1, 4.2, 9.3, 14.1, 14.2_

- [x] 12. 增强 Webview UI - 工具调用可视化





  - 创建 ToolCallDisplay 组件
  - 实现工具调用的视觉标识（图标、工具名称、参数）
  - 实现工具结果的显示（成功/失败状态、结果内容）
  - 实现可折叠的工具详情
  - 区分推理文本、工具调用和工具结果的视觉样式
  - _Requirements: 14.1, 14.2, 14.3, 14.4, 14.5_

- [x] 13. 增强 Webview UI - 输入和控制





  - 创建 InputBox 组件（支持多行输入）
  - 实现发送按钮和快捷键（Ctrl+Enter）
  - 实现输入禁用状态（任务执行中）
  - 添加加载指示器
  - 实现清空对话按钮
  - _Requirements: 4.1, 9.4_

- [x] 14. 增强 Webview UI - 模式选择器





  - 创建 ModeSelector 组件
  - 实现模式切换 UI（下拉菜单或按钮组）
  - 显示当前模式和模式图标
  - 实现模式切换消息发送到 Extension
  - 在 AgentWebviewProvider 中处理模式切换消息
  - _Requirements: 7.5, 7.6_

- [x] 15. 优化 UI 主题适配





  - 使用 VSCode CSS 变量实现主题适配
  - 适配深色主题
  - 适配浅色主题
  - 实现主题切换监听
  - 优化代码高亮主题匹配
  - _Requirements: 3.5_

- [x] 16. 检查点 - 测试完整用户体验
  - 确保 UI 流畅响应
  - 确保消息显示正确
  - 确保工具调用可视化清晰
  - 确保模式切换正常工作

### 第四阶段：配置、历史和错误处理

- [x] 17. 实现配置系统




  - 在 package.json 中添加配置项定义（API、权限、模式等）
  - 实现配置读取和保存逻辑
  - 使用 VSCode SecretStorage 存储 API 密钥
  - 实现配置验证（API 连接测试）
  - 在 AgentWebviewProvider 中使用配置系统
  - 创建配置 UI（Webview 或使用 VSCode 设置）
  - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ]* 17.1 为配置系统编写单元测试
  - 测试配置读取和保存
  - 测试配置验证
  - 测试 API 密钥存储和检索
  - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5_

- [x] 18. 实现对话历史管理








  - 实现对话历史的持久化（使用 VSCode Memento）
  - 实现对话历史的智能截断（基于 token 数量）
  - 实现清空对话功能
  - 实现对话历史加载和恢复
  - 在 UI 中显示对话历史
  - _Requirements: 4.3, 4.4, 4.5_

- [x] 19. 实现操作历史记录





  - 创建操作历史数据模型（OperationRecord）
  - 实现操作记录功能（记录所有文件操作）
  - 创建操作历史显示 UI
  - 实现操作撤销提示（引导用户使用 VSCode 撤销）
  - _Requirements: 11.1, 11.2, 11.3, 11.4, 11.5_

- [x] 20. 实现错误处理系统






  - 创建 ErrorHandler 类
  - 实现各种错误类型的处理（API 错误、工具错误、解析错误）
  - 实现自动重试机制（网络错误）
  - 实现错误日志记录
  - 在 UI 中显示友好的错误消息
  - 实现错误恢复策略
  - _Requirements: 12.1, 12.2, 12.3, 12.4, 12.5_

- [ ]* 20.1 为错误处理系统编写单元测试
  - 测试各种错误场景
  - 测试重试机制
  - 测试错误恢复
  - _Requirements: 12.1, 12.2, 12.3, 12.4, 12.5_

- [x] 21. 检查点 - 测试配置和错误处理
  - 确保配置系统正常工作
  - 确保对话历史正确保存和恢复
  - 确保错误处理友好且有效

### 第五阶段：性能优化和高级功能

- [x] 22. 优化性能和用户体验
  - 实现上下文缓存（文件内容、项目结构）
  - 优化流式输出性能（批量更新 UI）
  - 实现请求取消功能
  - 优化大文件处理
  - 实现响应时间监控
  - _Requirements: 9.1, 9.2, 9.4, 9.5_

- [x] 23. 实现代码分析和诊断增强
  - 增强 GetDiagnosticsTool 以提供更详细的诊断信息
  - 实现诊断结果的格式化显示
  - 实现重构建议生成（基于诊断）
  - 实现代码修改预览
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 24. 实现调试辅助功能
  - 实现错误定位功能（解析堆栈跟踪）
  - 实现堆栈跟踪分析工具
  - 实现相关代码高亮（在编辑器中）
  - 实现多文件关系分析
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

### 第六阶段：测试和发布准备

- [x] 25. 完善文档
  - 更新 README.md（功能介绍、安装指南、使用说明）
  - 添加使用示例和截图
  - 创建配置指南
  - 添加故障排除文档
  - 创建 CHANGELOG.md

- [ ]* 26. 集成测试和端到端测试
  - 编写 ReAct 循环集成测试
  - 编写完整用户场景测试（代码分析、Bug 修复、重构）
  - 编写性能测试
  - 修复发现的问题

- [x] 27. 最终检查点
  - 确保所有核心功能正常工作
  - 验证所有需求已实现
  - 检查代码质量和规范
  - 进行用户测试
  - 准备发布

## 任务说明

### 标记说明
- `[ ]` - 未开始的任务
- `[x]` - 已完成的任务
- `[ ]*` - 可选任务（主要是测试相关）

### 实现顺序
任务按照六个阶段组织，每个阶段都有明确的检查点：

1. **第一阶段（任务 1-6）**：动态提示词系统和核心工具 - 建立动态系统的基础
2. **第二阶段（任务 7-10）**：高级工具和上下文系统 - 增强 Agent 能力
3. **第三阶段（任务 11-16）**：UI 增强和用户体验 - 完善用户界面
4. **第四阶段（任务 17-21）**：配置、历史和错误处理 - 提升稳定性
5. **第五阶段（任务 22-24）**：性能优化和高级功能 - 优化体验
6. **第六阶段（任务 25-27）**：测试和发布准备 - 准备发布

### 测试策略
- 标记为 `*` 的测试任务是可选的，可以根据开发进度决定是否实施
- 核心功能应该通过手动测试验证
- 集成测试在第六阶段进行
- 每个阶段结束都有检查点任务，确保功能正常

### 关键设计变更
相比原计划，本任务列表做了以下重要调整：

1. **动态系统提示词**：不再使用静态的 systemPrompt.md 文件，而是通过 PromptBuilder 动态生成，可以根据工作模式、可用工具、上下文信息等动态调整
2. **工作模式系统**：ModeManager 与 PromptBuilder 集成，每种模式有不同的提示词片段和行为配置
3. **工具定义注入**：系统提示词中的工具文档从 ToolExecutor 动态获取，新增工具自动出现在提示词中
4. **分阶段实现**：将任务分为六个清晰的阶段，每个阶段都有明确的目标和检查点

### 检查点说明
- **任务 6**：验证动态提示词系统、工作模式、基础工具和权限系统
- **任务 10**：验证所有工具正常工作，上下文收集正确
- **任务 16**：验证完整的 UI 和用户交互体验
- **任务 21**：验证配置系统、历史管理和错误处理
- **任务 27**：最终发布前的全面检查
